services:
  # 1. Database
  postgres:
    image: postgres:16-alpine
    container_name: blog_postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USERNAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Backend BLUE
    backend-blue:
      build:
        context: .
        dockerfile: Dockerfile.backend
      container_name: backend-blue
      restart: always
      depends_on:
        postgres:
          condition: service_healthy
      environment: &backend_env
        # ... (Keep your existing env vars) ...
        HOST: 0.0.0.0
        PORT: 1337
      ports:
        - "1337:1337"
      networks:
        - app-network
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:1337/_health"]
        interval: 15s
        timeout: 5s
        retries: 5
        start_period: 20s

    # 3. Backend GREEN
    backend-green:
      build:
        context: .
        dockerfile: Dockerfile.backend
      container_name: backend-green
      restart: always
      depends_on:
        postgres:
          condition: service_healthy
      environment:
        <<: *backend_env
        PORT: 1337
      ports:
        - "1338:1337"
      networks:
        - app-network
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:1337/_health"]
        interval: 15s
        timeout: 5s
        retries: 5
        start_period: 20s

    # 4. Frontend BLUE
    frontend-blue:
      build:
        context: .
        dockerfile: Dockerfile.frontend
        args:
          NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL}
          NEXT_PUBLIC_SITE_NAME: "True North Vibes"
          # CHANGE: Use variable instead of hardcoded backend-blue
          STRAPI_INTERNAL_URL: ${STRAPI_INTERNAL_URL}
      container_name: frontend-blue
      restart: always
      ports:
        - "3000:3000"
      environment:
        NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL}
        # CHANGE: Pass the variable to runtime as well
        STRAPI_INTERNAL_URL: ${STRAPI_INTERNAL_URL}
      networks:
        - app-network
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:3000/"]
        interval: 10s
        timeout: 5s
        retries: 20
        start_period: 30s

    # 5. Frontend GREEN
    frontend-green:
      build:
        context: .
        dockerfile: Dockerfile.frontend
        args:
          NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL}
          NEXT_PUBLIC_SITE_NAME: "True North Vibes"
          # CHANGE: Use variable instead of hardcoded backend-green
          STRAPI_INTERNAL_URL: ${STRAPI_INTERNAL_URL}
      container_name: frontend-green
      restart: always
      ports:
        - "3001:3000"
      environment:
        NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL}
        # CHANGE: Pass the variable to runtime as well
        STRAPI_INTERNAL_URL: ${STRAPI_INTERNAL_URL}
      networks:
        - app-network
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:3000/"]
        interval: 10s
        timeout: 5s
        retries: 20
        start_period: 30s

  networks:
    app-network:
      driver: bridge

  volumes:
    postgres_data: